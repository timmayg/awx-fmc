---
- hosts: all
  connection: httpapi
  tasks:
    - name: 01 - Get Domain
      cisco.fmcansible.fmc_configuration:
        operation: getAllDomain
        register_as: domains

#    - name: 01a - Debug Domain Response
#      debug:
#        var: domains

    - name: 02 - Set domain_uuid
      set_fact:
        domain_uuid: "{{ domains[0]['uuid'] }}"

# https://developer.cisco.com/docs/fmc-ansible/getravpngateway/#example
    - name: 03 - Execute 'getRaVpnGateway' operation
      cisco.fmcansible.fmc_configuration:
        operation: "getRaVpnGateway"
        path_params:
            domainUUID: "{{ domain_uuid }}"
      register: response

#    - name: 03a - Debug response
#      debug:
#        var: response


    - name: 04 - Set expiry date fact
      set_fact:
        expiry_date: "{{ response['response']['items'][0]['certEnrollments'][0]['certificateInfo']['expiry'] }}"

#    - name: 04a - Parse the expiry date
#      set_fact:
#        expiry_datetime: "{{ expiry_date | community.general.date_parse }}"

    - name: 05 - Convert Expiry Date string to DateTime Object
      set_fact:
        expiry_datetime: "{{ expiry_date | to_datetime }}"

    - name: 06 - Obtain the Current Date Time
      set_fact:
        current_datetime: "{{ ansible_date_time.iso8601 }}"

    - name: 06 - Set Current Date Time
      set_fact:
        current_datetime: "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%S') }}"
    
    - name: 07 - Convert Current Date Time to DateTime Object
      set_fact:
        current_datetime_obj: "{{ current_datetime | to_datetime }}"


#    - name: 07a - Debug response
#      debug:
#        var: current_datetime

    - name: 08 - Calculate difference between expiry date and today
      set_fact:
        days_until_expiry: "{{ (expiry_date - current_datetime).days }}"

    - name: 09 - Check if the expiry date is before today or within 30 days
      debug:
        msg: >
          {% if days_until_expiry < 0 %}
            The certificate has already expired.
          {% elif days_until_expiry <= 30 %}
            The certificate will expire within the next 30 days.
          {% else %}
            The certificate is valid for more than 30 days.
          {% endif %}

